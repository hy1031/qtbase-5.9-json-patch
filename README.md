# QtBase 5.9.4 with large JSON support

This is a patched version of qtbase-5.9.4 with support of large JSON files (up to 1023 MB of the internal representation).

The original implementation of JSON in Qt has a limitation: the addressing in the internal JSON data structure uses 
27-bit values which limits the maximal size of this data structure to be 127 MB. Therefore, valid JSON files larger than
~130MB in text format cause `QJsonParseError::DocumentTooLarge`.

This patch mitigates the limit by increasing the addressing to a 30-bit value thus allowing representations up to 1023 MB

All JSON unit tests in `tests/auto/corelib/json` pass. The binary JSON test was replaced by a
binary JSON generated by the patched implementation.

The repository contains a patched qtbase 5.9.4 in the branch `json-patch`. The patch itself is located in the root 
directory of the same branch (json_20180507.patch).

## Known Issues

* Increased memory footprint due to usage of 64-bit value containers instead of 32-bit
* `QJsonDocument::toJson(QJsonDocument::Indented)` on very large documents causes `std::bad_alloc` on 32-bit systems due to exponential expansion of `QByteArray::reserve`
  * Possible solution: implement a streaming `QJsonDocument::toJson()`
  * Writing out with `QJsonDocument::Compact` is more robust
* Binary JSONs created by the original implementation are not compatible with the patched one and vice versa
  * A compatibility layer can be implemented if needed, binary JSONs produced by the patched implementation have `Version` set to 2u 

## Steps Needed for a General Solution

* The size of the backing data type should be controlled via a template parameter. This would enable arbitrary addressing size limited by the RAM
* Streaming writing API for `QJsonDocument::toJson()` accepting QIODevice
* Backwards compatibility for binary JSON format based on `Version`

## Authors

The patch was developed by sequality software engineering e.U. in 2018
